"use strict";var request_crawl_org_funding_delta_url="/request-crawl-org-funding-delta/";var get_funding="/get-funding/";var similar_to_organizations_url="/similar-to-organization/";var manage_similar_organization_to_report_alert_url='/manage-similar-organization-to-report-alert/';var edit_similar_organization_to_report_alert_url='/edit-similar-organization-to-report-alert/';function request_crawl_org_funding_delta(org_id,org_slug){_do_request_crawl_org_funding_delta(org_id,org_slug)
$("#financials_tab_id").off("click");}
function _set_refresh_funding_behaviour(org_id){let funding_updates_status_label=$("#funding_updates_status");funding_updates_status_label.addClass("clickable");funding_updates_status_label.on("click",function(){reload_funding_table(org_id);});}
function _update_status_label(newLabel){let funding_updates_status_label=$("#funding_updates_status");funding_updates_status_label[0].innerHTML=newLabel;}
function _do_request_crawl_org_funding_delta(org_id,org_slug){let csrf_token=getCookie('csrftoken');$.ajax({url:request_crawl_org_funding_delta_url,type:"POST",data:JSON.stringify({"org-id":org_id,"org-slug":org_slug}),headers:{"Content-Type":"application/json; charset=UTF-8","X-CSRFToken":csrf_token}}).done(function(data){if(data.notify){let updates_num=data.number;_update_status_label("Status: "+updates_num+" new funding round updates have been detected. "+"Refresh the page to see them. <i class=\"fas fa-redo-alt\"></i>");_set_refresh_funding_behaviour(org_id);}else{_update_status_label("Status: Up to date");}}).fail(function(xhr){_update_status_label("Status: Up to date");});}
function reload_funding_table(org_id){let csrf_token=getCookie('csrftoken');let funding_table_container=$("#financials_table");let funding_loading_spinner=$("#financials_loading");funding_table_container.hide();funding_loading_spinner.show();$.ajax({url:get_funding,type:"GET",data:{"org-id":org_id,"render_html":true},headers:{"Content-Type":"application/json; charset=UTF-8","X-CSRFToken":csrf_token}}).done(function(data){let funding_table_html=data["funding_table"];funding_table_container.html(funding_table_html);}).fail(function(xhr){commentGrowl("Funding reload is taking too long. Please, try again later.",'my-error');}).always(function(){funding_loading_spinner.hide();funding_table_container.show();});}
function init_financials_table(){let financials_table=$("#financials_list");financials_table.DataTable({"searching":false,"order":[[0,'desc']],"autoWidth":false,"columnDefs":[{"orderSequence":["desc","asc"],"targets":"_all"}],});financials_table.on('draw',function(){scrollToTab();});}
function load_similar_organizations(org_id,is_tech_rec=false){let similar_to_organization_table_selector='#similar-to-table';if(!$.fn.DataTable.isDataTable(similar_to_organization_table_selector)){let filter_values_json_copy=jQuery.extend(true,{},filter_values_json);filter_values_json_copy['org_id']=org_id;filter_values_json_copy['is_tech_rec']=is_tech_rec;filter_values_json_copy['render_html']=true;filter_values_json_copy['url']=window.location.href;let similar_to_organization_table_container=$("#similar-organisations-list");let similar_to_organization_loading_spinner=$("#similar-organisations-list-loading");similar_to_organization_table_container.hide();similar_to_organization_table_container.empty();similar_to_organization_loading_spinner.show();$.ajax({url:similar_to_organizations_url,type:"GET",data:filter_values_json_copy}).done(function(data){let similar_to_organization_table_html=data["similar_to_organizations_html"];similar_to_organization_table_container.html(similar_to_organization_table_html);similar_to_organization_loading_spinner.hide();similar_to_organization_table_container.show();onElementVisible("similar-organisations-list",function(){init_similar_to_organization_table();},true);});}else{$(similar_to_organization_table_selector).DataTable().draw();}}
function init_similar_to_organization_table(){let similar_to_organization_table_selector='#similar-to-table';let similar_to_organization_table=$(similar_to_organization_table_selector);let id_table_wrapper='#similar-organisations-list';if(!$.fn.DataTable.isDataTable(similar_to_organization_table_selector)){similar_to_organization_table.DataTable({"drawCallback":function(){initialize_popovers(`${id_table_wrapper} .filter-column-icon`);initialize_tooltips();},"order":[[1+index_columns_filters_offset,'asc']],"columnDefs":[{"orderSequence":['desc','asc'],"targets":"_all"}],"autoWidth":true,"oLanguage":{"sInfo":"Showing _START_ to _END_ of _TOTAL_ similar organizations"},"pageLength":10,"lengthChange":false,"scrollX":true,"searching":true,"fixedColumns":{"left":2}});}
similar_to_organization_table.on('draw',function(){scrollToTab();initialize_popovers(`${id_table_wrapper} .filter-column-icon`);initialize_tooltips();});$(similar_to_organization_table_selector).ready(function(){initialize_popovers(`${id_table_wrapper} .filter-column-icon`);initialize_tooltips();});}
function add_or_delete_organization_to_report_alert(similar_org_id,operation,alert_node_id,reload,on_done){max_score_for_manual_orgs=max_score_for_manual_orgs+1;let filter_values_json_copy=jQuery.extend(true,{},filter_values_json);filter_values_json_copy['similar_org_id']=similar_org_id;filter_values_json_copy['operation']=operation;filter_values_json_copy['render_html']=true;filter_values_json_copy['alert_node_id']=alert_node_id;filter_values_json_copy['url']=window.location.href;filter_values_json_copy['max_score_for_manual_orgs']=max_score_for_manual_orgs;show_loading_ajax_filters();$.ajax({url:manage_similar_organization_to_report_alert_url,type:"POST",data:filter_values_json_copy,beforeSend:function(xhr){xhr.setRequestHeader("X-CSRFToken",getCookie('csrftoken'));}}).done(function(data){if(reload)window.location.reload()
else on_done(data)}).always(()=>{if(!reload)remove_loading_ajax_filters();});}
function edit_similar_organizations_report_from_innoscout(alert_id){let filter_values_json_copy=jQuery.extend(true,{},filter_values_json);filter_values_json_copy['alert_id']=alert_id;filter_values_json_copy['url']=window.location.href;show_loading_ajax_filters();$.ajax({url:edit_similar_organization_to_report_alert_url,type:"POST",data:filter_values_json_copy,beforeSend:function(xhr){xhr.setRequestHeader("X-CSRFToken",getCookie('csrftoken'));}}).done(function(data){commentGrowl("Your tech rec was updated successfully.","my-info");window.location.reload()}).fail(function(data){if(data.responseJSON&&data.responseJSON.error){console.log(data.responseJSON.error);}else{console.log(data.statusText)}});}
function enable_buttons_to_edit_view_similar_organizations_report(alert_id){let name_query_org_report_edit_view_wrapper_e=$('#name_query_org_report_edit_view_wrapper')
$('#name_query_org_report_button').remove();name_query_org_report_edit_view_wrapper_e.removeClass("hidden");let similar_orgs_report_alert_edit_button=name_query_org_report_edit_view_wrapper_e.find('.similar-orgs-report-alert-edit-button')
similar_orgs_report_alert_edit_button.attr('onclick','edit_similar_organizations_report_from_innoscout("'+alert_id+'");');}
function generate_similar_organizations_report(reload=false){add_or_delete_organization_to_report_alert(null,'no-org',null,reload,function(data){add_similar_org_url_to_link(data['existing_special_report_desc_url']);enable_buttons_to_edit_view_similar_organizations_report(data['report_alert_id']);commentGrowl('Successfully tech rec created.',"my-info");})}
function add_similar_org_url_to_link(report_alert){let report_link_e=$('#name_query_org_report_edit_view_wrapper .similar-orgs-report-alert-link-button');if(report_link_e.length){report_link_e.attr("href",report_alert);report_link_e.removeClass('no-report-link');}}
function add_org_to_tech_rec(picture,name,slug,org_id,showNotification=true){add_new_search_org_to_filter(picture,name,slug,false);let org_rows=$('#organisations-list [data-org-id="'+org_id+'"], #similar-organisations-list [data-org-id="'+org_id+'"]');if(org_rows.length){let delete_button=org_rows.find('.delete_similar_org_btn');let add_button=org_rows.find('.add_similar_org_btn');let selected_label=org_rows.find('.verified-label');let score_label=org_rows.find('.score-value-text');add_button.addClass("hidden");delete_button.removeClass("hidden");selected_label.removeClass("hidden");score_label.addClass("hidden");org_rows.each(function(){let org_row_e=$(this);if(org_row_e.is("input"))org_row_e.prop('checked',true);});}
if(showNotification)
commentGrowl('The organization was added successfully',"my-info");}
function remove_org_to_tech_rec(slug,org_id,showNotification=true){let org_filter_remove_button=$('#aff-ui-id-'+slug+' .fa-times-circle');if(org_filter_remove_button.length){remove_kw_aff_complex_search(org_filter_remove_button,false,false);let org_rows=$('#organisations-list [data-org-id="'+org_id+'"], #similar-organisations-list [data-org-id="'+org_id+'"]');if(org_rows.length){let delete_button=org_rows.find('.delete_similar_org_btn');let add_button=org_rows.find('.add_similar_org_btn');let selected_label=org_rows.find('.verified-label');let score_label=org_rows.find('.score-value-text');add_button.removeClass("hidden");delete_button.addClass("hidden");score_label.removeClass("hidden");selected_label.addClass("hidden");org_rows.each(function(){let org_row_e=$(this);if(org_row_e.is("input"))org_row_e.prop('checked',false);})}
if(showNotification)
commentGrowl('The organization was removed successfully',"my-info");}}
$(window).on('resize',function(){$(".dataTables_scrollHeadInner").width($(".dataTables_scrollBody").width());});function launch_similar_organizations_modal(org_id){const similarOrganizationInnoscoutModal_e=$("#similarOrganizationInnoscoutModal");bootstrap.Modal.getOrCreateInstance(similarOrganizationInnoscoutModal_e).show();load_similar_organizations(org_id,true);$(".dataTables_scrollHeadInner").width($(".dataTables_scrollBody").width());}
function update_orgs_tech_rec_based_on_selected_similar_orgs(){let similar_orgs_table_selector='#similar-to-table';let similar_orgs_table=$(similar_orgs_table_selector);let select_orgs_checkboxes=similar_orgs_table.DataTable().$('.select-similar-org-for-tech-rec-input');show_loading_ajax_filters();select_orgs_checkboxes.each(function(){let org_id=this.getAttribute("data-org-id");let org_name=this.getAttribute("data-org-name");let org_slug=this.getAttribute("data-org-slug");let org_picture=this.getAttribute("data-org-picture");let is_org_checked=this.checked;if(is_org_checked){add_org_to_tech_rec(org_picture,org_name,org_slug,org_id,false)}else{remove_org_to_tech_rec(org_slug,org_id,false);}});bootstrap.Modal.getOrCreateInstance($("#similarOrganizationInnoscoutModal")).hide();let edit_tech_rech_button=$('#name_query_org_report_edit_view_wrapper .similar-orgs-report-alert-edit-button');if(edit_tech_rech_button.length&&edit_tech_rech_button[0].checkVisibility()){edit_tech_rech_button.click();}else{generate_similar_organizations_report(true);}};